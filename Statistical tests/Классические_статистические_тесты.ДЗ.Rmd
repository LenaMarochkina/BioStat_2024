---
title: "Классические_статистические_тесты.ДЗ"
author: "Elena Marochkina"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез.
В качестве задания протестируйте их, используя соответствующие статистические критерии.
Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы.
При необходимости аргументируйте выбор одностороннего теста.
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.

-   Решение необходимо загружать в формате Rmd (воспроизводимый код). \*\* Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr \*\*\* Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).

# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size \<- 100). Как изменится стратегия при малых выборках (sample_size \<- 30) ?

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("high", "low"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(
  activity == "high",
  rbinom(sample_size, 1, prob = 0.5),
  rbinom(sample_size, 1, prob = 0.6)
) 

df_100 <- data.frame(activity, cardio)

```

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("high", "low"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(
  activity == "high",
  rbinom(sample_size, 1, prob = 0.5),
  rbinom(sample_size, 1, prob = 0.6)
) 

df_30 <- data.frame(activity, cardio)

rm(activity, cardio, sample_size)
```

## Решение

```{r}
# Создадим таблицы сопряженности

table_30 <- table(df_30$activity, df_30$cardio)
table_30

table_100 <- table(df_100$activity, df_100$cardio)
table_100

# Критическое значение для alpha = 0.05
critical_upper <- qchisq(1 - 0.05, 99)
critical_lower <- qchisq(0.05, 99)

# Точный тест Фишера
fisher_test_30 <- fisher.test(table_30)
print(fisher_test_30)

# Хи-квадрат тест
chisq_test_100 <- chisq.test(table_100)
chisq_stat <- chisq_test_100$statistic

print(chisq_test_100)

list(
  critical_upper = critical_upper,
  critical_lower = critical_lower,
  chisq_stat = chisq_stat
)

rm(df_100, df_30, fisher_test_30, chisq_test_100, table_30, table_100, chisq_stat, critical_lower, critical_upper)
```

**H0:** Частота возникновения ССЗ *одинакова* у пациентов старше 50 лет в группах активности

**H1:** Частота возникновения ССЗ *различается* у пациентов старше 50 лет в группах активности

**Уровень значимости (α):** 0.05

**Выбранный тест (30 пациентов):** Тест Фишера

**Выбранный тест (100 пациентов):** Хи-квадрат

Зависимая переменная и исход являются бинарными переменными, выбор тестов обусловлен количесвтом значений в таблицах сопряженности

**Критическое значение статистики:** Тест Фишера не опирается на статистику теста для аппроксимации распределения данных.
Вместо этого он вычисляет точное p-значение, которое напрямую сравнивается с уровнем значимости.

Определялось только для выборки 100 пациентов (выбранный тест Хи-квадрат) Критическое значение за пределами диапозона: [77.05, 123.23]

**Наблюдаемое значение статистики:** Определялось только для выборки 100 пациентов (выбранный тест Хи-квадрат) Наблюдаемое значение: 3.078

**Статистическая значимость (30 пациентов):** По результатам анализа p-value = 0.702, следовательно, мы не можем отвергнуть нулевую гипотезу.

**Статистическая значимость (100 пациентов):** По результатам анализа p-value = 0.07934, следовательно, мы не можем отвергнуть нулевую гипотезу.
Наблюдаемое значение не попадает в критическую область.

**Клиническая значимость:** Клинически разница в рисках возникновения ССЗ в 10%, по-моему мнению, слишкам мала.

Для n=30 OR = 1.53 - выглядит как потенциально значимая связь.
Однако широкий доверительный интервал (0.25–11.98) для n=30 и отсутствие значимости для n=100 указывают, что разница может быть случайной.

# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 

# Генерация данных для группы с новым методом лечения 
group1 <- rnorm(sample_size, mean = 130, sd = 10)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 135, sd = 10)  # контрольная группа

df <- data.frame(
  treatment = c(rep("experimental", sample_size), rep("control", sample_size)),
  systolic_bp = c(group1, group2)
)

```

## Решение

```{r}
# Односторонний левосторонний t-тест
t_test_left <- t.test(
  group1, group2, 
  alternative = "less",
  var.equal = TRUE
)

# Вывод результатов
print(t_test_left)

# Расчёт критического значения статистики (левосторонний критерий)
critical_lower <- qt(0.05, df = 79, lower.tail = TRUE)

list(
  critical_lower = critical_lower,
  w_statistic = round(t_test_left$statistic, 2),
  CI_lower = round(t_test_left$conf.int[1], 3),
  CI_upper = round(t_test_left$conf.int[2], 3)
)

rm(t_test_left, critical_lower, df, group1, group2, sample_size)

```

**H0:** Средние значения САД одинаковы в группах экспериментального и контрольного препаратов (mexp = mcontrol)

**H1:** Среднее значение САД в группе экспериментального препарата ниже, чем в группе контрольного препарата (mexp \< mcontrol)

**Уровень значимости (α):** 0.05

**Выбранный тест:** Поскольку САД количественная переменная и вероятно распределена нормально (предположение), используем односторонний t-тест для двух независимых выборок (левосторонний).

**Статистическая значимость:** По результатам анализа p-value = 0.009451, следовательно, отвергаем нулевую гипотезу.
Наблюдаемое значение статистики (-2.37) лежит в критической области (\<-1.65)

**Клиническая значимость:** В экспериментаьной группе САД оказалось ниже на 3.75 мм рт.
ст.
(что может быть сравнимо со средней погрешностью тонометра 3 мм рт. ст.).
Считаю, что разница слишком мала, для того,чтобы считать ее клинически значимой.

# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, size = 100, prob = 0.6)

df <- data.frame(patient_id = 1:sample_size, before = before, after = after) 
```

## Решение

```{r}

critical <- qsignrank(0.95, 30)

# Тест Вилкоксона
wilcox_test <- wilcox.test(df$after, df$before, 
                                    paired = TRUE, 
                                    alternative = "greater", 
                                    exact = FALSE, 
                                    conf.int = TRUE)

# Вывод результата
wilcox_test

list(
  critical = critical,
  stat = round(wilcox_test$statistic, 2),
  CI_lower = round(wilcox_test$conf.int[1], 3),
  CI_upper = round(wilcox_test$conf.int[2], 3)
)

rm(df, wilcox_test, after, before, critical, sample_size)

```

**H0:** Среднее значение балла физической активности после и до реабилитации одинаково: (mafter = mbefore)

**H1:** Среднее значение балла физической активности после реабилитации *выше, чем* среднее значение балла физической активности до реабилитации: (mafter \> mbefore)

**Уровень значимости (α):** 0.05

**Выбранный тест:** Для небольшой выборки и связанных данных (где измерения "до" и "после" относятся к одному пациенту), будем использовать непараметрический тест Вилкоксона для связанных выборок.

**Статистическая значимость:** По результатам анализа p-value \<\< 0.05, следовательно, отвергаем нулевую гипотезу.
Наблюдательное значение статистики (446.5) выше чем критическое значение статистики (313).

**Клиническая значимость:**

В среднем балл физической активности увеличивается на 11 баллов после реабилитации, что может быть клинически значимым результатом.

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200

# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- sample(c("experimental", "test"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ifelse(
  treatment == "experimental",
  rbinom(sample_size, 1, prob = 0.7), # 70% нормальной активности
  rbinom(sample_size, 1, prob = 0.65) # 65% нормальной активности
)

df <- data.frame(treatment, activity)
    
```

## Решение

```{r}
# Создаём таблицу сопряжённости
table_data <- table(df$treatment, df$activity)

# Вычисляем доли
n_experimental <- sum(df$treatment == "experimental")
n_test <- sum(df$treatment == "test")
p_experimental <- sum(df$treatment == "experimental" & df$activity == 1) / n_experimental
p_test <- sum(df$treatment == "test" & df$activity == 1) / n_test

# Объединенная пропорция (для стандартной ошибки)
p_pooled <- (sum(df$activity == 1)) / sample_size

# Стандартная ошибка
se <- sqrt(p_pooled * (1 - p_pooled) * (1/n_experimental + 1/n_test))

# Z-статистика
z_stat <- (p_experimental - p_test) / se

# P-значение для одностороннего теста
p_value <- 1 - pnorm(z_stat)

# Критическое значение
z_critical <- qnorm(0.95)

# Результаты
list(
  z_statistic = z_stat,
  p_value = p_value,
  critical_value = z_critical,
  proportions = c(p_experimental = p_experimental, p_test = p_test)
)

rm(df, activity, n_experimental, n_test, p_experimental, p_pooled, p_test, p_value, sample_size, se, table_data, treatment, z_critical, z_stat )

```

**H0:** Доля пациентов, вернувшихся к нормальной физической активности, одинаковая при новом методе лечения и стандартном (mexp = mtest)

**H1:** Доля пациентов, вернувшихся к нормальной физической активности, выше при новом методе лечения (mexp \> mtest)

**Уровень значимости (α):** 0.05

**Выбранный тест:** Используем z-тест для двух пропорций, так как сравниваем доли в двух независимых группах.

**Критическое значение:** Для одностороннего теста при 𝛼= 0.05 критическое значение равняется 1.645.

**Наблюдаемое значение:** Доля пациентов, вернувшихся к нормальной физической активности

-   В экспериментальной группе: 0.739
-   В контрольной группе : 0.618

Разница между долями составляет 0.121.

**Статистическая значимость:** Поскольку наблюдаемое значение \> критичечского значения и p-value \< 0.05, мы отвергаем нулевую гипотезу

**Клиническая значимость:** Разница в долях (12.1%) указывает на потенциально значимый эффект нового метода лечения.

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- rbinom(sample_size, 1, prob = 0.5)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- ifelse(
      before == 1, 
      rbinom(sample_size, 1, prob = 0.2), 
      0)

df <- data.frame(before, after)
```

## Решение

```{r}
# Создание таблицы сопряжённости
table_data <- table(df$before, df$after)

# Критическое значение
critical_low <- qchisq(0.05, df = 1)
critical_upper <- qchisq(1 - 0.05, df = 1)

# Критерий Макнемара (двусторонний тест по умолчанию)
mcnemar_test <- mcnemar.test(table_data)

# Результаты
list(
  table = table_data,       
  critical_low = critical_low,
  critical_upper = critical_upper,
  statistic = mcnemar_test$statistic,  
  p_value = mcnemar_test$p.value        
)

rm(df, mcnemar_test, after, before, critical_low, critical_upper, sample_size, table_data)
```

**H0:** Медитация не влияет на наличие стресса (доля лиц со стрессом до и после медитации одинаковая: (mbefore = mafter)

**H1:** Медитация влияет на наличие стресса (доля лиц со стрессом до и после медитации не одинаковая): (mafter != mbefore)

**Уровень значимости (α):** 0.05

**Выбранный тест:** Для сравнения двух зависимых выборок с бинарными данными (до и после медитации) используется критерий Макнемара.

**Критическое значение:** Критическое значение для уровня значимости α=0.05: 3.841

**Наблюдаемое значение:** Наблюдаемое значение тестовой статистики: 27.034

**Статистическая значимость:** Есть статистически значимые изменения в уровне стресса до и после медитации (наблюдательная статистика \> критическое значение, p-value \< 0.05, отвергаем нулевую гипотезу)

**Клиническая значимость:** у 29 человек уровень стресса снизился, и только у 2 человек произошли обратные изменения.
Это свидетельствует о практической эффективности медитации для снижения стресса.

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
group1 <- rbinom(n = sample_size, 100, 0.55)

group2 <- rbinom(n = sample_size, 100, 0.68)


```

## Решение

```{r}
# Определение критических значений
critical_upper = qwilcox(1 - 0.05/2, 20, 20)
critical_lower = qwilcox(0.05/2, 20, 20)

# Критерий Манна–Уитни
wilcox_test <- wilcox.test(group1, group2, 
                           alternative = "two.sided", 
                           exact = FALSE, 
                           conf.int = TRUE)

# Результаты теста
list(
  critical_upper = critical_upper,
  critical_lower = critical_lower,
  statistic = wilcox_test$statistic, 
  p_value = wilcox_test$p.value, 
  conf_int = wilcox_test$conf.int 
)

rm(wilcox_test, critical_lower, critical_upper, group1, group2, sample_size)

```

**H0:** Средний балл симптомов депрессии в экспериментальной группе равен среднему баллу в контрольной группе (mexp = mtest)

**H1:** Средний балл симптомов депрессии в экспериментальной группе неравен среднему баллу в контрольной группе (mexp != mtest)

**Уровень значимости (α):** 0.05

**Выбранный тест:** Так как не информации о распределении данных, используем непараметрический критерий Манна–Уитни (Wilcoxon Rank-Sum Test) для проверки гипотезы.

**Критическое значение:** Для двустороннего теста при𝛼= 0.05 критическое значение вне диапозона [128, 272].

**Наблюдаемое значение:** Наблюдаемая статистика W=9, что значительно меньше нижнего критического значения (128).

**Статистическая значимость:** p-value \<\< 0.05, мы отвергаем нулевую гипотезу.

**Клиническая значимость:** Экспериментальная группа имеет медиану на 10–16 пунктов ниже, чем контрольная, вероятно клинически значимо.

# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
r <- -0.5
sd_sleep <- 2  # Стандартное отклонение для HoursOfSleep
sd_stress <- 3 # Стандартное отклонение для StressLevel
cov_matrix <- matrix(c(sd_sleep^2, r * sd_sleep * sd_stress, 
                       r * sd_sleep * sd_stress, sd_stress^2), 
                     nrow = 2)

# Генерация данных
df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))

# Просмотр данных
head(df)

```

## Решение (дополните решение визуализацией)

```{r}
library(ggplot2)

# Критические значения статистики

critical_upper <- qt(p = 1 - 0.05/2, 98)
critical_lower <- qt(p =  0.05/2, 98)

# Рассчёт корреляции
correlation_test <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")

# Результаты
list(
  critical_lower = critical_lower,
  critical_upper = critical_upper,
  correlation = correlation_test$estimate,
  statistic = correlation_test$statistic,
  p_value = correlation_test$p.value
)

# График
ggplot(df, aes(x = HoursOfSleep, y = StressLevel)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "pink", se = TRUE) +
  labs(
    title = "Связь между длительностью сна и уровнем стресса",
    x = "Длительность сна (часы)",
    y = "Уровень стресса"
  ) +
  theme_minimal()

rm(correlation_test, cov_matrix, df, critical_lower, critical_upper, means, r, sample_size, sd_sleep, sd_stress)
```

**H0:** Длительность сна не ассоциирована с уровнем стресса (r=0)

**H1:** Длительность сна ассоциирована с уровнем стресса (r != 0)

**Уровень значимости (α):** 0.05

**Выбранный тест:** Пирсоновский коэффициент корреляции.

**Критическое значение:** Для двустороннего теста при𝛼= 0.05 критическое значение вне диапозона [-1.98, 1.98].

**Наблюдаемое значение:** Наблюдаемая статистика t=-6.1, что значительно меньше нижнего критического значения (-1.98).

**Статистическая значимость:** p-value \<\< 0.05, мы отвергаем нулевую гипотезу.

**Клиническая значимость:** Отрицательный коэффициент корреляции (r= −0.525) подтверждает, что увеличение времени сна связано с уменьшением уровня стресса.
