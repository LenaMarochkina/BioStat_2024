---
title: "Study of the predictive ability of immunological status and clustering features on the development of chronic graft-versus-host disease after allogeneic hematopoietic stem cell transplantation."
author: "Elena Marochkina"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(dplyr)
library(stringr)
library(tidyr)
```

# 1. Read and Clean Data

``` {r clean data}
# Read data and rename columns
df <- readxl::read_excel("./data/AI_Tcells_DB.xlsx") 

# Clean the data 
df_clean <- df %>%
  # Rename columns
  rename(
    Subject_ID = ID,
    Observation_Days_Count = Time_OS,
    cGVHD_Diagnosis_Day = cGVHD_time,
    Cell_Count = Abs_Value
  ) %>%
  mutate(
    # Add flag to indicate which patients experienced cGVHD
    cGVHD_flag = as.numeric(ifelse(!is.na(cGVHD_Diagnosis_Day), 1, 0)),
    
    # Add exact day when blood test was perform 
    Blood_test_exact_day = case_when(
      grepl('ДЕНЬ ХРРТПХ_ПЕР.КРОВЬ', df$Names) ~ cGVHD_Diagnosis_Day,
      grepl('ДЕНЬ ХРРТПХ +', Names) ~ as.numeric(str_extract(Names, "(?<=\\+)\\d+(?=_)")) + cGVHD_Diagnosis_Day,
      TRUE ~ as.numeric(str_extract(Names, "(?<=\\+)\\d+(?=_)"))
    ), 
    
    # Add blood test group 
    Blood_test_group = case_when(
      grepl('ДЕНЬ ХРРТПХ_ПЕР.КРОВЬ', df$Names) ~ "cGVHD Diagnosis Day",
      grepl('ДЕНЬ ХРРТПХ +', df$Names) ~ paste0("Day ", str_extract(df$Names, "(?<=\\+)\\d+(?=_)"), " After cGVHD"),
      TRUE ~ paste0(str_extract(df$Names, "(?<=\\+)\\d+(?=_)"), " day")
    ),
    
    # Create exact cell name
    Cell_name = str_extract(Names, "(?<=/)\\S+")
  ) %>%
  select(-Names) %>%
  replace()

unify_cell_name <- function(cell_name, replacements) {
  cell_name_unified <- cell_name
  for (replacement in replacements) {
    old_value <- replacement[1]
    new_value <- replacement[2]
    cell_name_unified <- str_replace_all(cell_name_unified, old_value, new_value)
  }
  return(cell_name_unified)
}

replacements <- list(
  c("PD1", "PD-1"),
  c("СТАР2", "STAR2"),
  c("4", "CD4_"),
  c("CD4_\\+", "CD4+_"),
  c("8", "CD8_"),
  c("CD8_\\+", "CD8+_"),
  c("Th", "TH"),
  c("__", "_"),
  c("+_", "")
)

# Apply the function to dataframe
df_clean <- df_clean %>%
  mutate(
    Cell_name_unified = Cell_name,
    Cell_name_unified = unify_cell_name(Cell_name, replacements)
    )

```